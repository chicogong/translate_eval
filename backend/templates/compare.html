<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Model Translation Comparison</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        .model-card {
            border: 2px solid #dee2e6;
            border-radius: 12px;
            transition: all 0.3s ease;
            min-height: 250px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .model-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }
        .model-card.success {
            border-color: #198754;
            background: linear-gradient(135deg, #d1eddb 0%, #f8fff9 100%);
        }
        .model-card.error {
            border-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #fff5f5 100%);
        }
        .model-card.evaluated {
            border-color: #0d6efd;
            background: linear-gradient(135deg, #cce7ff 0%, #f0f8ff 100%);
        }
        .model-selector {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        .translation-result {
            min-height: 100px;
            padding: 15px;
            border-radius: 8px;
            background-color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            border: 1px solid #e9ecef;
            margin-bottom: 10px;
        }
        .model-name {
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .model-badge {
            background: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: normal;
        }
        .evaluation-section {
            border-top: 1px solid #e9ecef;
            padding-top: 10px;
            margin-top: 10px;
        }
        .score-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .score-badge {
            background: #0d6efd;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .evaluator-tag {
            background: #6f42c1;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
            margin-right: 4px;
        }
        .justification-text {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #0d6efd;
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .evaluation-controls {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 1px solid #dee2e6;
        }
        .btn-evaluate {
            background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(13, 110, 253, 0.3);
            transition: all 0.3s ease;
        }
        .btn-evaluate:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(13, 110, 253, 0.4);
        }
        .progress-ring {
            display: inline-block;
            margin-right: 8px;
        }
        .animate-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .evaluation-summary {
            background: linear-gradient(135deg, #e7f3ff 0%, #f0f8ff 100%);
            border: 1px solid #b6d7ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .summary-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0d6efd;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <header class="bg-primary text-white p-3 mb-4">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="mb-0"><i class="fas fa-balance-scale me-2"></i>Multi-Model Translation Comparison</h1>
                        <p class="mb-0">Compare translations from multiple AI models side by side</p>
                    </div>
                    <div>
                        <a href="/" class="btn btn-outline-light">
                            <i class="fas fa-arrow-left me-2"></i>Back to Main
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Input Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Translation Settings</h5>
                        </div>
                        <div class="card-body">
                            <!-- Language Selection -->
                            <div class="row mb-3">
                                <div class="col-md-5">
                                    <label for="source-lang" class="form-label">Source Language</label>
                                    <select class="form-select" id="source-lang">
                                        {% for code, name in languages.items() %}
                                        <option value="{{ code }}" {% if code == 'zh' %}selected{% endif %}>{{ name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2 text-center">
                                    <label class="form-label">&nbsp;</label>
                                    <div>
                                        <button class="btn btn-outline-secondary" id="swap-languages" title="Swap Languages">
                                            <i class="fas fa-exchange-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <label for="target-lang" class="form-label">Target Language</label>
                                    <select class="form-select" id="target-lang">
                                        {% for code, name in languages.items() %}
                                        <option value="{{ code }}" {% if code == 'en' %}selected{% endif %}>{{ name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <!-- Model Selection -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label class="form-label">Select Models for Comparison (2-6 models)</label>
                                    <div class="model-selector" id="model-selector">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading available models...
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Text Input -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label for="source-text" class="form-label">Source Text</label>
                                    <textarea class="form-control" id="source-text" rows="4" 
                                              placeholder="Enter text to translate and compare..."></textarea>
                                    <div class="mt-2 d-flex justify-content-between align-items-center">
                                        <small class="text-muted">Characters: <span id="char-count">0</span></small>
                                        <div>
                                            <button class="btn btn-primary" id="compare-btn" disabled>
                                                <i class="fas fa-balance-scale me-1"></i>Compare Translations
                                            </button>
                                            <button class="btn btn-outline-secondary ms-2" id="clear-btn">
                                                <i class="fas fa-trash me-1"></i>Clear
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results-section" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4><i class="fas fa-chart-bar me-2"></i>Translation Results</h4>
                    <div id="summary-info" class="text-muted"></div>
                </div>
                
                <!-- Evaluation Controls -->
                <div id="evaluation-controls" class="evaluation-controls" style="display: none;">
                    <h5><i class="fas fa-star me-2"></i>AI Quality Evaluation</h5>
                    <p class="text-muted mb-3">Get professional evaluation scores from multiple AI judges</p>
                    <button class="btn btn-primary btn-evaluate" id="evaluate-btn">
                        <i class="fas fa-gavel me-2"></i>Evaluate All Translations
                    </button>
                    <div id="evaluator-info" class="mt-2 text-muted"></div>
                </div>
                
                <!-- Evaluation Summary -->
                <div id="evaluation-summary" class="evaluation-summary" style="display: none;">
                    <h5><i class="fas fa-trophy me-2"></i>Evaluation Summary</h5>
                    <div class="summary-stats" id="summary-stats">
                        <!-- Stats will be populated here -->
                    </div>
                </div>
                
                <div class="comparison-grid" id="comparison-grid">
                    <!-- Results will be populated here -->
                </div>
            </div>

            <!-- Loading Section -->
            <div id="loading-section" style="display: none;">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Translating with multiple models...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let availableModels = [];
        let selectedModels = [];
        let availableEvaluators = [];
        let currentTranslations = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableModels();
            loadAvailableEvaluators();
            setupEventListeners();
        });

        function loadAvailableModels() {
            fetch('/api/models')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        availableModels = data.models;
                        renderModelSelector();
                    } else {
                        document.getElementById('model-selector').innerHTML = 
                            '<div class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading models: ' + data.error + '</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading models:', error);
                    document.getElementById('model-selector').innerHTML = 
                        '<div class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Failed to load models</div>';
                });
        }

        function loadAvailableEvaluators() {
            fetch('/api/evaluators')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        availableEvaluators = data.evaluators;
                        updateEvaluatorInfo();
                    } else {
                        console.error('Error loading evaluators:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error loading evaluators:', error);
                });
        }

        function updateEvaluatorInfo() {
            const evaluatorInfo = document.getElementById('evaluator-info');
            if (availableEvaluators.length > 0) {
                const evaluatorNames = availableEvaluators.map(e => e.name).join(', ');
                evaluatorInfo.innerHTML = `<i class="fas fa-info-circle me-1"></i>Available evaluators: ${evaluatorNames}`;
            } else {
                evaluatorInfo.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>No evaluators configured';
            }
        }

        function renderModelSelector() {
            const container = document.getElementById('model-selector');
            container.innerHTML = '';

            availableModels.forEach(model => {
                const div = document.createElement('div');
                div.className = 'form-check mb-2';
                div.innerHTML = `
                    <input class="form-check-input" type="checkbox" value="${model.id}" id="model-${model.id}">
                    <label class="form-check-label" for="model-${model.id}">
                        <strong>${model.name}</strong>
                        <small class="text-muted d-block">${model.model}</small>
                    </label>
                `;
                container.appendChild(div);
            });

            // Pre-select first two models if available
            if (availableModels.length >= 2) {
                document.getElementById(`model-${availableModels[0].id}`).checked = true;
                document.getElementById(`model-${availableModels[1].id}`).checked = true;
                updateSelectedModels();
            }
        }

        function setupEventListeners() {
            // Model selection
            document.getElementById('model-selector').addEventListener('change', updateSelectedModels);

            // Text input
            document.getElementById('source-text').addEventListener('input', function() {
                document.getElementById('char-count').textContent = this.value.length;
                updateCompareButtonState();
            });

            // Language swap
            document.getElementById('swap-languages').addEventListener('click', function() {
                const sourceLang = document.getElementById('source-lang');
                const targetLang = document.getElementById('target-lang');
                const temp = sourceLang.value;
                sourceLang.value = targetLang.value;
                targetLang.value = temp;
            });

            // Compare button
            document.getElementById('compare-btn').addEventListener('click', performComparison);

            // Clear button
            document.getElementById('clear-btn').addEventListener('click', function() {
                document.getElementById('source-text').value = '';
                document.getElementById('char-count').textContent = '0';
                document.getElementById('results-section').style.display = 'none';
                document.getElementById('evaluation-controls').style.display = 'none';
                document.getElementById('evaluation-summary').style.display = 'none';
                currentTranslations = {};
                updateCompareButtonState();
            });

            // Evaluate button
            document.getElementById('evaluate-btn').addEventListener('click', performEvaluation);
        }

        function updateSelectedModels() {
            const checkboxes = document.querySelectorAll('#model-selector input[type="checkbox"]');
            selectedModels = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            updateCompareButtonState();
        }

        function updateCompareButtonState() {
            const text = document.getElementById('source-text').value.trim();
            const hasText = text.length > 0;
            const hasModels = selectedModels.length >= 2 && selectedModels.length <= 6;
            
            document.getElementById('compare-btn').disabled = !hasText || !hasModels;
        }

        function performComparison() {
            const sourceText = document.getElementById('source-text').value.trim();
            const sourceLang = document.getElementById('source-lang').value;
            const targetLang = document.getElementById('target-lang').value;

            if (!sourceText || selectedModels.length < 2) {
                alert('Please enter text and select at least 2 models for comparison.');
                return;
            }

            // Show loading
            document.getElementById('loading-section').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';

            // Prepare request
            const requestData = {
                source_lang: sourceLang,
                target_lang: targetLang,
                text: sourceText,
                model_ids: selectedModels,
                stream: false
            };

            fetch('/api/translate/compare', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading-section').style.display = 'none';
                
                if (data.success) {
                    displayResults(data);
                } else {
                    alert('Translation failed: ' + data.error);
                }
            })
            .catch(error => {
                document.getElementById('loading-section').style.display = 'none';
                console.error('Error:', error);
                alert('An error occurred during translation.');
            });
        }

        function displayResults(data) {
            const grid = document.getElementById('comparison-grid');
            grid.innerHTML = '';

            // Store current translations
            currentTranslations = data.results;

            // Update summary
            const summary = data.summary;
            document.getElementById('summary-info').innerHTML = 
                `<i class="fas fa-check-circle text-success me-1"></i>${summary.successful_models}/${summary.total_models} models completed successfully`;

            // Show evaluation controls if there are successful translations and evaluators
            const successfulCount = summary.successful_models;
            if (successfulCount > 0 && availableEvaluators.length > 0) {
                document.getElementById('evaluation-controls').style.display = 'block';
            }

            // Create result cards
            Object.entries(data.results).forEach(([modelId, result]) => {
                const card = document.createElement('div');
                card.className = `model-card ${result.success ? 'success' : 'error'}`;
                card.id = `card-${modelId}`;
                
                if (result.success) {
                    card.innerHTML = `
                        <div class="card-body">
                            <div class="model-name">
                                <span><i class="fas fa-robot me-2"></i>${result.model_name}</span>
                                <span class="model-badge">${result.model_id}</span>
                            </div>
                            <div class="translation-result">
                                ${result.translation}
                            </div>
                            <div class="evaluation-section" id="eval-${modelId}" style="display: none;">
                                <!-- Evaluation results will be inserted here -->
                            </div>
                            <div class="mt-3 d-flex justify-content-between align-items-center">
                                <small class="text-muted">Model: ${result.model_id}</small>
                                <button class="btn btn-sm btn-outline-primary" onclick="copyTranslation('${result.translation.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-copy me-1"></i>Copy
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    card.innerHTML = `
                        <div class="card-body">
                            <div class="model-name">
                                <span><i class="fas fa-robot me-2"></i>${result.model_name || modelId}</span>
                                <span class="model-badge error">Failed</span>
                            </div>
                            <div class="translation-result text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Translation failed: ${result.error}
                            </div>
                        </div>
                    `;
                }
                
                grid.appendChild(card);
            });

            document.getElementById('results-section').style.display = 'block';
        }

        function performEvaluation() {
            if (!currentTranslations || Object.keys(currentTranslations).length === 0) {
                alert('No translations to evaluate. Please perform translation first.');
                return;
            }

            if (availableEvaluators.length === 0) {
                alert('No evaluators configured. Please check your configuration.');
                return;
            }

            const sourceText = document.getElementById('source-text').value.trim();
            const sourceLang = document.getElementById('source-lang').value;
            const targetLang = document.getElementById('target-lang').value;

            // Update button state
            const evaluateBtn = document.getElementById('evaluate-btn');
            const originalHtml = evaluateBtn.innerHTML;
            evaluateBtn.disabled = true;
            evaluateBtn.innerHTML = '<span class="progress-ring animate-pulse"><i class="fas fa-spinner fa-spin"></i></span>Evaluating...';

            // Prepare request
            const requestData = {
                source_lang: sourceLang,
                target_lang: targetLang,
                source_text: sourceText,
                translations: currentTranslations
            };

            fetch('/api/evaluate/compare', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                evaluateBtn.disabled = false;
                evaluateBtn.innerHTML = originalHtml;
                
                if (data.success) {
                    displayEvaluationResults(data);
                } else {
                    alert('Evaluation failed: ' + data.error);
                }
            })
            .catch(error => {
                evaluateBtn.disabled = false;
                evaluateBtn.innerHTML = originalHtml;
                console.error('Error:', error);
                alert('An error occurred during evaluation.');
            });
        }

        function displayEvaluationResults(data) {
            // Show evaluation summary
            const summaryDiv = document.getElementById('evaluation-summary');
            const statsDiv = document.getElementById('summary-stats');
            
            // Calculate overall statistics
            const results = data.results;
            const translationKeys = Object.keys(results);
            const scores = translationKeys.map(key => results[key].average_score).filter(score => score > 0);
            const avgScore = scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
            const bestScore = scores.length > 0 ? Math.max(...scores) : 0;
            const totalEvaluations = data.summary.evaluations_performed;

            statsDiv.innerHTML = `
                <div class="stat-item">
                    <div class="stat-number">${avgScore.toFixed(1)}</div>
                    <div class="stat-label">Average Score</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${bestScore.toFixed(1)}</div>
                    <div class="stat-label">Best Score</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${totalEvaluations}</div>
                    <div class="stat-label">Total Evaluations</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${availableEvaluators.length}</div>
                    <div class="stat-label">Evaluators Used</div>
                </div>
            `;

            summaryDiv.style.display = 'block';

            // Update individual cards with evaluation results
            Object.entries(results).forEach(([modelId, evaluationResult]) => {
                const card = document.getElementById(`card-${modelId}`);
                const evalSection = document.getElementById(`eval-${modelId}`);
                
                if (card && evalSection) {
                    // Update card class to show it's evaluated
                    card.className = card.className.replace('success', 'evaluated');
                    
                    // Create evaluation content
                    const evaluatorDetails = evaluationResult.evaluator_details;
                    const avgScore = evaluationResult.average_score;
                    const justification = evaluationResult.combined_justification;

                    let evaluatorTags = '';
                    evaluatorDetails.forEach(detail => {
                        const scoreText = detail.success ? detail.score : 'Failed';
                        evaluatorTags += `<span class="evaluator-tag" title="${detail.justification}">${detail.evaluator_name}: ${scoreText}</span>`;
                    });

                    evalSection.innerHTML = `
                        <div class="score-display">
                            <span><strong>AI Evaluation Score:</strong></span>
                            <span class="score-badge">${avgScore}/10</span>
                        </div>
                        <div class="mb-2">
                            ${evaluatorTags}
                        </div>
                        <div class="justification-text">
                            <strong>Evaluation Details:</strong><br>
                            ${justification.replace(/\n/g, '<br>')}
                        </div>
                    `;
                    
                    evalSection.style.display = 'block';
                }
            });

            // Hide evaluation controls
            document.getElementById('evaluation-controls').style.display = 'none';
        }

        function copyTranslation(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Show success feedback
                const toast = document.createElement('div');
                toast.className = 'toast-notification';
                toast.innerHTML = '<i class="fas fa-check me-2"></i>Translation copied to clipboard!';
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #28a745;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 5px;
                    z-index: 9999;
                `;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        }
    </script>
</body>
</html> 