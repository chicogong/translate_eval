<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Model Translation Comparison</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        .model-card {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            transition: all 0.3s ease;
            min-height: 200px;
        }
        .model-card.success {
            border-color: #198754;
            background-color: #d1eddb;
        }
        .model-card.error {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        .model-selector {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
        }
        .translation-result {
            min-height: 120px;
            padding: 15px;
            border-radius: 5px;
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
        }
        .model-name {
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <header class="bg-primary text-white p-3 mb-4">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="mb-0"><i class="fas fa-balance-scale me-2"></i>Multi-Model Translation Comparison</h1>
                        <p class="mb-0">Compare translations from multiple AI models side by side</p>
                    </div>
                    <div>
                        <a href="/" class="btn btn-outline-light">
                            <i class="fas fa-arrow-left me-2"></i>Back to Main
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Input Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Translation Settings</h5>
                        </div>
                        <div class="card-body">
                            <!-- Language Selection -->
                            <div class="row mb-3">
                                <div class="col-md-5">
                                    <label for="source-lang" class="form-label">Source Language</label>
                                    <select class="form-select" id="source-lang">
                                        {% for code, name in languages.items() %}
                                        <option value="{{ code }}" {% if code == 'zh' %}selected{% endif %}>{{ name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2 text-center">
                                    <label class="form-label">&nbsp;</label>
                                    <div>
                                        <button class="btn btn-outline-secondary" id="swap-languages" title="Swap Languages">
                                            <i class="fas fa-exchange-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <label for="target-lang" class="form-label">Target Language</label>
                                    <select class="form-select" id="target-lang">
                                        {% for code, name in languages.items() %}
                                        <option value="{{ code }}" {% if code == 'en' %}selected{% endif %}>{{ name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <!-- Model Selection -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label class="form-label">Select Models for Comparison (2-6 models)</label>
                                    <div class="model-selector" id="model-selector">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading available models...
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Text Input -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label for="source-text" class="form-label">Source Text</label>
                                    <textarea class="form-control" id="source-text" rows="4" 
                                              placeholder="Enter text to translate and compare..."></textarea>
                                    <div class="mt-2 d-flex justify-content-between align-items-center">
                                        <small class="text-muted">Characters: <span id="char-count">0</span></small>
                                        <div>
                                            <button class="btn btn-primary" id="compare-btn" disabled>
                                                <i class="fas fa-balance-scale me-1"></i>Compare Translations
                                            </button>
                                            <button class="btn btn-outline-secondary ms-2" id="clear-btn">
                                                <i class="fas fa-trash me-1"></i>Clear
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results-section" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4><i class="fas fa-chart-bar me-2"></i>Translation Results</h4>
                    <div id="summary-info" class="text-muted"></div>
                </div>
                
                <div class="comparison-grid" id="comparison-grid">
                    <!-- Results will be populated here -->
                </div>
            </div>

            <!-- Loading Section -->
            <div id="loading-section" style="display: none;">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Translating with multiple models...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let availableModels = [];
        let selectedModels = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableModels();
            setupEventListeners();
        });

        function loadAvailableModels() {
            fetch('/api/models')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        availableModels = data.models;
                        renderModelSelector();
                    } else {
                        document.getElementById('model-selector').innerHTML = 
                            '<div class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading models: ' + data.error + '</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading models:', error);
                    document.getElementById('model-selector').innerHTML = 
                        '<div class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Failed to load models</div>';
                });
        }

        function renderModelSelector() {
            const container = document.getElementById('model-selector');
            container.innerHTML = '';

            availableModels.forEach(model => {
                const div = document.createElement('div');
                div.className = 'form-check mb-2';
                div.innerHTML = `
                    <input class="form-check-input" type="checkbox" value="${model.id}" id="model-${model.id}">
                    <label class="form-check-label" for="model-${model.id}">
                        <strong>${model.name}</strong>
                        <small class="text-muted d-block">${model.model}</small>
                    </label>
                `;
                container.appendChild(div);
            });

            // Pre-select first two models if available
            if (availableModels.length >= 2) {
                document.getElementById(`model-${availableModels[0].id}`).checked = true;
                document.getElementById(`model-${availableModels[1].id}`).checked = true;
                updateSelectedModels();
            }
        }

        function setupEventListeners() {
            // Model selection
            document.getElementById('model-selector').addEventListener('change', updateSelectedModels);

            // Text input
            document.getElementById('source-text').addEventListener('input', function() {
                document.getElementById('char-count').textContent = this.value.length;
                updateCompareButtonState();
            });

            // Language swap
            document.getElementById('swap-languages').addEventListener('click', function() {
                const sourceLang = document.getElementById('source-lang');
                const targetLang = document.getElementById('target-lang');
                const temp = sourceLang.value;
                sourceLang.value = targetLang.value;
                targetLang.value = temp;
            });

            // Compare button
            document.getElementById('compare-btn').addEventListener('click', performComparison);

            // Clear button
            document.getElementById('clear-btn').addEventListener('click', function() {
                document.getElementById('source-text').value = '';
                document.getElementById('char-count').textContent = '0';
                document.getElementById('results-section').style.display = 'none';
                updateCompareButtonState();
            });
        }

        function updateSelectedModels() {
            const checkboxes = document.querySelectorAll('#model-selector input[type="checkbox"]');
            selectedModels = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            updateCompareButtonState();
        }

        function updateCompareButtonState() {
            const text = document.getElementById('source-text').value.trim();
            const hasText = text.length > 0;
            const hasModels = selectedModels.length >= 2 && selectedModels.length <= 6;
            
            document.getElementById('compare-btn').disabled = !hasText || !hasModels;
        }

        function performComparison() {
            const sourceText = document.getElementById('source-text').value.trim();
            const sourceLang = document.getElementById('source-lang').value;
            const targetLang = document.getElementById('target-lang').value;

            if (!sourceText || selectedModels.length < 2) {
                alert('Please enter text and select at least 2 models for comparison.');
                return;
            }

            // Show loading
            document.getElementById('loading-section').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';

            // Prepare request
            const requestData = {
                source_lang: sourceLang,
                target_lang: targetLang,
                text: sourceText,
                model_ids: selectedModels,
                stream: false
            };

            fetch('/api/translate/compare', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading-section').style.display = 'none';
                
                if (data.success) {
                    displayResults(data);
                } else {
                    alert('Translation failed: ' + data.error);
                }
            })
            .catch(error => {
                document.getElementById('loading-section').style.display = 'none';
                console.error('Error:', error);
                alert('An error occurred during translation.');
            });
        }

        function displayResults(data) {
            const grid = document.getElementById('comparison-grid');
            grid.innerHTML = '';

            // Update summary
            const summary = data.summary;
            document.getElementById('summary-info').innerHTML = 
                `<i class="fas fa-check-circle text-success me-1"></i>${summary.successful_models}/${summary.total_models} models completed successfully`;

            // Create result cards
            Object.entries(data.results).forEach(([modelId, result]) => {
                const card = document.createElement('div');
                card.className = `model-card ${result.success ? 'success' : 'error'}`;
                
                if (result.success) {
                    card.innerHTML = `
                        <div class="card-body">
                            <div class="model-name">
                                <i class="fas fa-robot me-2"></i>${result.model_name}
                            </div>
                            <div class="translation-result">
                                ${result.translation}
                            </div>
                            <div class="mt-3 d-flex justify-content-between align-items-center">
                                <small class="text-muted">Model: ${result.model_id}</small>
                                <button class="btn btn-sm btn-outline-primary" onclick="copyTranslation('${result.translation.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-copy me-1"></i>Copy
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    card.innerHTML = `
                        <div class="card-body">
                            <div class="model-name">
                                <i class="fas fa-robot me-2"></i>${result.model_name || modelId}
                            </div>
                            <div class="translation-result text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Translation failed: ${result.error}
                            </div>
                        </div>
                    `;
                }
                
                grid.appendChild(card);
            });

            document.getElementById('results-section').style.display = 'block';
        }

        function copyTranslation(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Show success feedback
                const toast = document.createElement('div');
                toast.className = 'toast-notification';
                toast.innerHTML = '<i class="fas fa-check me-2"></i>Translation copied to clipboard!';
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #28a745;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 5px;
                    z-index: 9999;
                `;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        }
    </script>
</body>
</html> 